Directly adapted from http://okmij.org/ftp/tagless-final/JFP.pdf.
